# Node.js

- Node.js는 Chrome V8 자바스크립트 엔진으로 빌드된 자바스크립트 런타임이다.
  > 런타임이란?
  >
  > - 특정 언어로 만든 프로그램들을 실행할 수 있는 환경, 노드는 자바스크립트 프로그램을 컴퓨터에서 실행할 수 있음

## 노드의 내부 구조

노드의 내부 구조     |       |
| -------------------- | ----- | ------- |
| Node.js Core Library |
| Node.js Bindings     |
| V8                   | libuv | 테스트3 |

**V8**

- 오픈 소스 자바스크립트 엔진

**libuv**

- 논블로킹 I/O 모델을 제공하는 라이브러리
- 해당 라이브러리를 통해 노드의 특성인 이벤트 기반, 논블로킹 I/O 모델을 구현

# 이벤트 기반

- 이벤트 기반이란 이벤트가 발생할 때 미리 지정해둔 작업을 수행하는 방식
- 이벤트 리스너에 콜백 함수를 틍록해서 사용하기

**이벤트 루프**

- 여러 이벤트가 동시에 발생했을 때 어떤 순서로 콜백 함수를 호출할지를 이벤트 루프가 판단
- 설명

  - 노드는 자바스크립트 코드의 맨 위부터 한 줄씩 실행. 함수 호출 부분을 발견했다면 호출한 함수를 호출 스택에 넣음

    ```typescript
    function a() {
      b();
      console.log("a");
    }
    function b() {
      c();
      console.log("b");
    }
    function c() {
      console.log("c");
    }
    a();

    => c
    => b
    => a
    ```

    - 이 경우 스택에는 a, b, c 순으로 쌓이고 콘솔에는 c, b, a 순으로 출력
    - 전역 컨텍스트가 먼저 쌓이긴 함

### 이벤트 루프, 태스크 큐, 백그라운드

- 이벤트 루프
  - 이벤트 발생 시 호출할 콜백 함수들을 관리하고, 호출된 콜백 함수의 실행 순서를 결정하는 역할을 담당
  - 노드가 종료될 때까지 이벤트 처리를 위한 작업을 반복하므로 루프
- 백그라운드
  - setTimeout 같은 타이머나 이벤트 리스너들이 대기하는 곳
  - 자바스크립트가 아닌 다른 언어로 작성된 프로그램이라고 봐도 됨
- 태스크 큐 - 이벤트 발생 후, 백그라운드에서는 태스크 큐로 타이머나 이벤트 리스너의 콜백 함수를 보냄 - 정해진 순서대로 콜백들이 줄을 서 있으므로 콜백 큐 라고도 부름 - 보통 완료된 순서대로 줄을 서 있지만 특정한 경우에는 순서가 바뀌기도 함
  > 이벤트 루프는 호출 스태깅 비어 있으면 태스크 큐에서 함수를 하나씩 가져와 호출 스택에 넣고 실행함

### setTimeout의 실행 시간 보장

- setTimeout은 정확한 실행 시간을 보장하지 않고, 최소 지연 시간만을 보장함
- 실행 과정:

  ```typescript
  console.log("시작");
  setTimeout(() => {
    console.log("3초 후");
  }, 3000);
  // 무거운 작업 (5초 소요)
  for (let i = 0; i < 1000000000; i++) {}
  console.log("끝");

  // 실행 결과:
  // '시작' 출력
  // 5초 후 '끝' 출력
  // 그 후 '3초 후' 출력 (실제로는 5초 이상 소요)
  ```

  1. setTimeout 호출 시 콜백은 백그라운드로 이동
  2. 지정된 시간이 지나면 태스크 큐로 이동
  3. 호출 스택이 비어있을 때까지 대기
  4. 이벤트 루프가 태스크 큐에서 콜백을 가져와 실행

## 논 블로킹 I/O

- 자바스크립트 코드는 동시에 실행될 수 없다. 하지만 인풋 아웃풋과 같은 작업들은 동시에 실행 가능하다.
- 이전 작업이 완료될 때까지 대기하지 않고 다음 작업을 수행함을 뜻함
- 코드를 논 블로킹으로 만드는 방법은 setTimeout 혹은 setImmediate를 사용하는 것
  - 그래도 이 방법은 실행 순서만 바뀔뿐이다, 그래도 다른 간단한 작업들이 대기하는 상황을 막을 수 있음.
  - 논 블로킹과 동시는 같은 말이 아니다.

### 논 블로킹/블로킹 과 비동기와 동기

- 지금은 동기와 블로킹이 유사하고, 비동기와 논블로킹이 유사하다고만 알아두고 나중에 공부하자

## 싱글 스레드

- 노드는 싱글 스레드이다.
- 싱글 스레드라서 우리가 작성한 자바스크립트 코드가 동시에 실행될 수 없는 것이다.
- 프로세스와 스레드의 차이
  - 프로세스는 운영체제에서 할당하는 작업의 단위, 스레드는 프로세스 내에서 실행되는 작업의 단위
    - 노드나 웹 브라우저 같은 프로그램은 개별 프로세스, 프로세스 간에는 메모리 자원을 공유하지 않음
  - 스레드는 프로세스 내에서 실행되는 흐름의 단위. 프로세스는 스레드를 여러 개 생성해 여러 작업을 동시에 처리 가능
    - 스레드는 부모 프로세스의 자원을 공유한다. 같은 주소의 메모리에 접근 가능하므로 데이터를 공유할 수 있다.
- 노드 프로세스가 여러 개의 스레드를 만들긴 하지만 개발자가 제어할 수 있는 스레드는 하나뿐이다.

### 스레드풀과 워커 스레드

- 노드가 싱글 스레드로 동작하지 않는 두 가지 경우가 있음
  - 스레드풀
    - 노드가 특정 동작을 수행할 때 스스로 멀티 스레드를 사용함. 암호화, 파일 입출력, 압축 등이 있음
  - 워커 스레드
    - 노드 12버전에서 안정화된 기능으로 개발자가 다수의 스레드를 다룰 수 있음

# 서버로서의 노드

- 논블로킹 I/O 방식으로 인해 스레드 하나가 많은 수의 I/O를 혼자서도 감당 가능
- CPU 부하가 큰 작업에는 어울리지 않음
- 그러면 어디에 사용하는게 가장 좋은 것인가?
  - **개수는 많지만 크기는 작은 데이터를 실시간으로 주고받는데 적합**
